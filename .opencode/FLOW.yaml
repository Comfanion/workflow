# Documentation & Sprint Management Workflow
# This file defines the complete workflow pipeline for AI-assisted development

name: documentation-workflow
version: "3.0"
description: |
  End-to-end workflow from research to implementation and review.
  
  Architecture: Commands â†’ Agents â†’ Skills
  - Commands: Entry points (user invokes)
  - Agents: Personas (WHO does work)
  - Skills: Knowledge (HOW to do things)
  
  Config: .opencode/config.yaml

# =============================================================================
# CONFIGURATION
# =============================================================================
config:
  file: .opencode/config.yaml
  variables:
    - user_name
    - communication_language
    - document_output_language
    - output_folder
    - sprint_artifacts
    - implementation_artifacts

# =============================================================================
# MCP TOOLS (Available to agents)
# =============================================================================
mcp:
  context7:
    use: "When researching library documentation (npm, Go, Python)"
    agents: [dev, architect, researcher]
  sequential-thinking:
    use: "For complex reasoning, architecture decisions, multi-step analysis"
    agents: [architect, analyst]

# =============================================================================
# WORKFLOW PIPELINE (Main Flow)
# =============================================================================
# 
# PLANNING PHASE:
#   research (opt) â†’ requirements â†’ prd â†’ coding-standards â†’ architecture
#
# SPRINT PHASE:
#   epics â†’ stories â†’ sprint-plan â†’ jira-sync
#
# IMPLEMENTATION PHASE:
#   dev-story â†’ code-review â†’ (repeat) â†’ retrospective
#
pipeline:
  stages:
    # =========================================================================
    # PLANNING PHASE
    # =========================================================================
    
    # OPTIONAL: Research before requirements
    - id: research
      name: Research (Optional)
      description: Technical, market, or domain research before requirements
      phase: planning
      optional: true
      command: /research [type] [topic]
      agent: researcher
      skills:
        - research-methodology
      artifacts:
        output:
          - docs/research/[type]/[topic]-research.md
      next: requirements

    - id: requirements
      name: Requirements Gathering
      description: Collect FR/NFR through stakeholder interviews
      phase: planning
      command: /requirements
      agent: analyst
      skills:
        - requirements-gathering
        - acceptance-criteria
      artifacts:
        output:
          - docs/requirements/requirements.md
      validation:
        command: /validate requirements
        skill: requirements-validation
        required: true
      next: prd

    - id: prd
      name: Product Requirements Document
      description: Create PRD from validated requirements
      phase: planning
      command: /prd
      agent: pm
      skills:
        - prd-writing
        - acceptance-criteria
      artifacts:
        input:
          - docs/requirements/requirements.md
        output:
          - docs/prd.md
      validation:
        command: /validate prd
        skill: prd-validation
        required: true
      qa:
        artifact: docs/prd-acceptance-criteria.md
        description: Acceptance criteria for all FRs
        template: skills/acceptance-criteria/template.md
        mandatory: true
      next: coding-standards

    - id: coding-standards
      name: Coding Standards
      description: Define coding patterns, style, and conventions
      phase: planning
      command: /coding-standards
      agent: architect
      skills:
        - coding-standards
      artifacts:
        input:
          - docs/prd.md
        output:
          - docs/coding-standards/README.md
          - docs/coding-standards/patterns.md
          - docs/coding-standards/testing.md
      next: architecture

    - id: architecture
      name: Architecture Design
      description: Create system architecture from PRD
      phase: planning
      command: /architecture
      agent: architect
      skills:
        - architecture-design
        - adr-writing
      artifacts:
        input:
          - docs/prd.md
          - CLAUDE.md
        output:
          - docs/architecture.md
          - docs/architecture/adr/*.md
      validation:
        command: /validate architecture
        skill: architecture-validation
        required: true
      qa:
        artifact: docs/architecture-integration-tests.md
        description: Integration test specifications
        template: skills/test-design/template-integration.md
        mandatory: true
      next: epics

    # =========================================================================
    # SPRINT PHASE
    # =========================================================================
    
    - id: epics
      name: Epic Creation
      description: Break PRD into implementation epics
      phase: sprint
      command: /epics
      agent: pm
      skills:
        - epic-writing
        - acceptance-criteria
      artifacts:
        input:
          - docs/prd.md
          - docs/architecture.md
        output:
          - docs/sprint-artifacts/backlog/epic-*.md
          - docs/sprint-artifacts/sprint-*/epic-*.md
      validation:
        command: /validate epics
        required: true
        rules:
          - All epics have acceptance criteria
      next: stories

    - id: stories
      name: Story Creation
      description: Create detailed stories for each epic
      phase: sprint
      command: /stories {epic-id}
      agent: pm
      skills:
        - story-writing
        - acceptance-criteria
      artifacts:
        input:
          - docs/sprint-artifacts/*/epic-*.md
        output:
          - docs/sprint-artifacts/*/stories/story-*.md
      validation:
        command: /validate stories
        required: true
        rules:
          - All stories have Given/When/Then AC
          - All stories have tasks/subtasks
      next: sprint-plan

    - id: sprint-plan
      name: Sprint Planning
      description: Organize epics and stories into sprints
      phase: sprint
      command: /sprint-plan
      agent: pm
      skills:
        - sprint-planning
      artifacts:
        output:
          - docs/sprint-artifacts/sprint-status.yaml
      next: jira-sync

    - id: jira-sync
      name: Jira Synchronization
      description: Sync epics/stories/tasks to Jira with development control
      phase: sprint
      command: /jira-sync [links...]
      agent: pm
      skills:
        - jira-integration
      artifacts:
        input:
          - docs/sprint-artifacts/*/epic-*.md
          - docs/sprint-artifacts/*/stories/story-*.md
        output:
          - docs/sprint-artifacts/jira-sync-report.md
          - .opencode/jira-cache.yaml
      modes:
        with_links: "User provides Jira links â†’ fetch, find related, ask what to update"
        auto_create: "No links â†’ scan local docs, create/update in Jira project"
      features:
        - cache_system
        - find_related_issues
        - control_development
        - branch_creation
      next: dev-story

    # =========================================================================
    # IMPLEMENTATION PHASE
    # =========================================================================
    
    - id: dev-story
      name: Story Implementation
      description: Implement story using red-green-refactor cycle
      phase: implementation
      command: /dev-story [story-path | jira-link]
      agent: dev
      skills:
        - dev-story
        - test-design
        - jira-integration
      artifacts:
        input:
          - docs/sprint-artifacts/*/stories/story-*.md
          - .opencode/jira-cache.yaml
          - CLAUDE.md
        output:
          - Implementation code
          - Unit tests
          - Integration tests
      jira_integration:
        on_start: "transition to in_progress, create branch"
        on_review: "transition to review, link PR"
        on_complete: "update Jira description with summary"
      next: code-review

    - id: code-review
      name: Code Review
      description: Review implemented code for quality and correctness
      phase: implementation
      command: /code-review [story-path]
      agent: dev
      skills:
        - code-review
      artifacts:
        input:
          - docs/sprint-artifacts/*/stories/story-*.md
        output:
          - Review comments in story file
          - Review follow-up tasks
      next: dev-story  # Loop back if changes requested

    - id: retrospective
      name: Sprint Retrospective
      description: Review sprint and capture learnings
      phase: implementation
      command: /retrospective
      agent: pm
      artifacts:
        output:
          - docs/sprint-artifacts/sprint-N/retrospective.md

# =============================================================================
# AGENTS (Personas - WHO does work)
# =============================================================================
# 
# Model Strategy (based on Jan 2026 research):
# - Architecture/Planning: Claude 4.5 Opus, Gemini 3 Pro (wisdom, context)
# - Development: DeepSeek-V3.2 (cheapest, fast), GLM-4.7 (preserved thinking)
# - Testing: GPT-5.2 Codex (best at finding bugs)
# - UI/Frontend: MiniMax-M2.1 (fast, aesthetic)
# - Research: Gemini 3 Pro (10M context, grounding)
#
agents:
  analyst:
    name: Sara
    title: Business Analyst
    icon: "ðŸ“Š"
    description: Requirements Analyst - extracts FR/NFR through stakeholder interviews
    mode: subagent
    model: anthropic/claude-sonnet-4-20250514
    temperature: 0.3
    file: agents/analyst.md
    expertise:
      - Requirements engineering
      - Business analysis
      - Stakeholder interviews
    personality: Methodical, thorough, asks clarifying questions
    skills_used:
      - requirements-gathering
      - requirements-validation
      - acceptance-criteria
      - unit-writing
      - methodologies

  pm:
    name: Dima
    title: Product Manager
    icon: "ðŸ“‹"
    description: Product Manager - creates PRDs, epics, stories, sprint planning, Jira sync
    mode: subagent
    model: anthropic/claude-sonnet-4-20250514
    temperature: 0.3
    file: agents/pm.md
    expertise:
      - Product management
      - B2B SaaS
      - Agile/Sprint planning
    personality: Business-focused, user-centric, data-driven
    skills_used:
      - prd-writing
      - prd-validation
      - acceptance-criteria
      - epic-writing
      - story-writing
      - sprint-planning
      - jira-integration
      - unit-writing
      - translation
      - methodologies

  architect:
    name: Winston
    title: Solution Architect
    icon: "ðŸ—ï¸"
    description: Solution Architect - designs system architecture, makes technical decisions
    mode: subagent
    model: anthropic/claude-sonnet-4-20250514
    temperature: 0.2
    file: agents/architect.md
    expertise:
      - Distributed systems
      - Architecture patterns (chooses based on context)
      - System design
    personality: Technical, precise, patterns-focused
    skills_used:
      - architecture-design
      - architecture-validation
      - adr-writing
      - coding-standards
      - unit-writing
      - methodologies

  dev:
    name: Rick
    title: Senior Developer
    icon: "ðŸ’»"
    description: Developer - implements stories following red-green-refactor cycle
    mode: subagent
    model: anthropic/claude-sonnet-4-20250514
    temperature: 0.2
    file: agents/dev.md
    expertise:
      - Software development
      - TDD/BDD
      - Code review
    personality: Precise, test-driven, follows story specifications exactly
    skills_used:
      - dev-story
      - code-review
      - test-design

  coder:
    name: Morty
    title: Fast Coder
    icon: "âš¡"
    description: Fast Coder - quick implementation, bug fixes, code following patterns
    mode: subagent
    hidden: true  # Internal subagent, invoked by @dev
    model: anthropic/claude-sonnet-4-20250514
    temperature: 0.1
    file: agents/coder.md
    expertise:
      - Quick implementation
      - Bug fixes
      - Following existing patterns
    personality: Fast, no questions, executes or fails

  reviewer:
    name: Marcus
    title: Code Reviewer
    icon: "ðŸ”"
    description: Code Reviewer - security-focused review, bug finding, test coverage
    mode: subagent
    model: openai/gpt-5.2-codex  # Best at finding bugs and security issues
    temperature: 0.1
    file: agents/reviewer.md
    expertise:
      - Security review
      - Bug finding
      - Test coverage analysis
      - Code quality
    personality: Thorough, security-paranoid, always suggests fixes
    skills_used:
      - code-review
    auto_invoke:
      trigger: story_tasks_complete  # Called automatically when all story tasks done
      before: story_marked_done

  # Supporting Agents (not in main pipeline)
  researcher:
    name: Kristina
    title: Researcher
    icon: "ðŸ”"
    description: Researcher - conducts technical, market, and domain research
    mode: subagent
    model: google/gemini-2.5-pro  # Best for research - 1M context, grounding
    # Alternatives: gemini-2.5-flash (faster), gemini-3-pro (preview)
    temperature: 0.4
    file: agents/researcher.md
    expertise:
      - Technical research
      - Market analysis
      - Domain expertise
      - Deep research with web grounding
    personality: Curious, thorough, evidence-based
    skills_used:
      - research-methodology
      - methodologies

  change-manager:
    name: Bruce
    title: Change Manager
    icon: "ðŸ”„"
    description: Change Manager - manages documentation change proposals
    mode: subagent
    model: anthropic/claude-sonnet-4-20250514
    temperature: 0.2
    file: agents/change-manager.md
    expertise:
      - Change management
      - Impact analysis
      - Version control
    personality: Careful, systematic, risk-aware
    skills_used:
      - change-management

# =============================================================================
# ARTIFACTS
# =============================================================================
artifacts:
  requirements:
    path: docs/requirements/requirements.md
    template: skills/requirements-gathering/template.md

  prd:
    path: docs/prd.md
    template: skills/prd-writing/template.md

  prd-qa:
    path: docs/prd-acceptance-criteria.md
    template: skills/acceptance-criteria/template.md
    mandatory: true

  architecture:
    path: docs/architecture.md
    template: skills/architecture-design/template.md

  architecture-qa:
    path: docs/architecture-integration-tests.md
    template: skills/test-design/template-integration.md
    mandatory: true

  epic:
    path: docs/sprint-artifacts/*/epic-*.md
    template: skills/epic-writing/template.md
    naming: "epic-{NN}-{module}-{description}.md"
    id_format: "{MODULE}-E{NN}"

  story:
    path: docs/sprint-artifacts/*/stories/story-*.md
    template: skills/story-writing/template.md
    naming: "story-{EPIC}-{NN}-{description}.md"
    id_format: "{MODULE}-S{EPIC}-{NN}"

  sprint-status:
    path: docs/sprint-artifacts/sprint-status.yaml
    template: skills/sprint-planning/template.yaml
    format: yaml

# =============================================================================
# QUICK START
# =============================================================================
quickstart:
  phases:
    - name: Planning
      steps:
        - step: 1
          command: /workflow-status
          description: Check current status

        - step: 2
          command: /requirements
          description: Gather requirements (if missing)

        - step: 3
          command: /validate requirements
          description: Validate requirements

        - step: 4
          command: /prd
          description: Create PRD

        - step: 5
          action: Create QA artifact
          file: docs/prd-acceptance-criteria.md
          description: AC for all FRs (MANDATORY)

        - step: 6
          command: /validate prd
          description: Validate PRD + QA artifact

        - step: 7
          command: /coding-standards
          description: Define coding standards

        - step: 8
          command: /architecture
          description: Design architecture

        - step: 9
          action: Create QA artifact
          file: docs/architecture-integration-tests.md
          description: Integration tests (MANDATORY)

        - step: 10
          command: /validate architecture
          description: Validate architecture + QA artifact

    - name: Sprint
      steps:
        - step: 11
          command: /epics
          description: Create epics

        - step: 12
          command: /stories {epic-id}
          description: Create stories for each epic

        - step: 13
          command: /sprint-plan
          description: Plan sprints

        - step: 14
          command: /jira-sync
          description: Sync to Jira

    - name: Implementation
      steps:
        - step: 15
          command: /dev-story
          description: Implement story (red-green-refactor)

        - step: 16
          command: /code-review
          description: Review implementation

        - step: 17
          action: Repeat steps 15-16
          description: Until all stories done

        - step: 18
          command: /retrospective
          description: Sprint retrospective

# =============================================================================
# HOOKS & EVENTS (Plugin Integration)
# =============================================================================
# 
# Workflow emits events that plugins can subscribe to.
# Plugins are in .opencode/plugins/ directory.
#
hooks:
  # Compaction hook - preserve context during session compaction
  compaction:
    plugin: custom-compaction.ts
    description: Preserves task/story status, critical files, continuation instructions
    context_files:
      always:
        - CLAUDE.md
        - AGENTS.md
        - project-context.md
        - .opencode/config.yaml
      if_exists:
        - docs/prd.md
        - docs/architecture.md
        - docs/coding-standards/README.md
        - docs/coding-standards/patterns.md
      dynamic:
        - active_story_file    # From sprint-status.yaml
        - modified_files       # Files edited in session

events:
  # Session lifecycle
  session:
    - session.started        # New session began
    - session.idle           # Agent finished responding
    - session.compacted      # Session was compacted
    - session.error          # Error occurred

  # Agent lifecycle  
  agent:
    - agent.activated        # Agent persona loaded
    - agent.skill.loaded     # Skill file was read
    - agent.task.started     # Agent started a task
    - agent.task.completed   # Agent completed a task

  # Workflow pipeline
  workflow:
    - workflow.stage.started     # Pipeline stage began
    - workflow.stage.completed   # Pipeline stage finished
    - workflow.stage.skipped     # Optional stage skipped
    - workflow.validation.passed # Validation succeeded
    - workflow.validation.failed # Validation failed

  # Document lifecycle
  document:
    - document.created       # New doc created
    - document.updated       # Doc modified
    - document.validated     # Doc passed validation
    - document.archived      # Doc moved to archive

  # Sprint/Story lifecycle
  sprint:
    - epic.created           # Epic document created
    - story.created          # Story document created
    - story.started          # Story status â†’ in-progress
    - story.task.completed   # Task marked [x]
    - story.completed        # All tasks done, status â†’ review
    - story.approved         # Code review passed, status â†’ done
    - sprint.planned         # Sprint planning completed
    - sprint.completed       # All stories done

  # Jira integration
  jira:
    - jira.sync.started      # Sync began
    - jira.sync.completed    # Sync finished
    - jira.issue.created     # New issue in Jira
    - jira.issue.updated     # Issue updated
    - jira.transition        # Status changed

# Example plugin subscriptions
# 
# .opencode/plugins/notifications.ts:
#   event: async ({ event }) => {
#     if (event.type === "story.completed") {
#       await sendSlackNotification(event.data)
#     }
#   }
#
# .opencode/plugins/jira-auto-sync.ts:
#   event: async ({ event }) => {
#     if (event.type === "story.task.completed") {
#       await updateJiraProgress(event.data)
#     }
#   }
